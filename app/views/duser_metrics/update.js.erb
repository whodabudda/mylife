<% require_dependency('h_s_series') %>
<% if @duser_metric.errors.any? %>

  // Create a list of errors
  var errors = $('<ul />');

  <% @duser_metric.errors.full_messages.each do |error| %>
    errors.append('<li><%= escape_javascript(error) %></li>');
  <% end %>

  alert(errors)
<% else %>
  console.log("updating point")
//  var new_row = $('<%=  j('#{render(:partial => "shared/duser_metric_tr", locals: {duser_metric: @duser_metric})}').html_safe %>');
  $("#tr_clone_<%=@duser_metric.id%>").replaceWith("<%= escape_javascript("#{render :partial => 'shared/duser_metric_tr', :locals => { :duser_metric => @duser_metric }}").html_safe %>");
  var $new_row = $("#tr_clone_<%=@duser_metric.id%> td .default_datetimepicker");
  $new_row.datetimepicker({
          format: 'Y-m-d H:i:s O',
          lazyInit:true,
          step: 1,
          validateOnBlur:false
      });
  $("#duser-metric-modal").modal("hide");

  <% @hss = HSSeries.new(Metric.find(@duser_metric.metric_id),@duser_metric.duser_id)
     @pointStr = @hss.formatPoint(@duser_metric)
  %>
  <% Rails.logger.info ( "In update.js.erb with new point value of: #{@pointStr}" )%> 
  <%if false %>
  <%end%>

  var thePoint = chart1.get(<%=@duser_metric.id%>);
  console.log("updating point: " + '<%= raw  @pointStr.to_json %>')
  if (thePoint) {
    thePoint.update(JSON.parse('<%=raw @pointStr.to_json%>'))
  }

  <% if false %>
   <% redirect_to "duser_session#home" %>
  <% end %>

<% end %>